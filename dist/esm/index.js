import{openDB as e}from"idb";import t from"crypto-js";function r(e,t,r,n){return new(r||(r=Promise))(function(a,o){function u(e){try{i(n.next(e))}catch(e){o(e)}}function c(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(u,c)}i((n=n.apply(e,t||[])).next())})}function n(e,t){var r,n,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},u=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return u.next=c(0),u.throw=c(1),u.return=c(2),"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function c(c){return function(i){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;u&&(u=0,c[0]&&(o=0)),o;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,n=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){o.label=c[1];break}if(6===c[0]&&o.label<a[1]){o.label=a[1],a=c;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(c);break}a[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,i])}}}"function"==typeof SuppressedError&&SuppressedError;var a="FormDraftDB",o="drafts",u="react-storage-secret-key",c=null,i=function(){return c||(c=e(a,1,{upgrade:function(e){e.createObjectStore(o,{keyPath:"key"})}})),c},s=function(e){return t.AES.encrypt(e,u).toString()},l=function(e){return t.AES.decrypt(e,u).toString(t.enc.Utf8)},f=function(e){return new Promise(function(t,r){var n=new FileReader;n.onload=function(){return t({name:e.name,type:e.type,data:n.result})},n.onerror=r,n.readAsDataURL(e)})},d=function(e){return r(void 0,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return[4,fetch(e.data)];case 1:return[4,n.sent().blob()];case 2:return t=n.sent(),r=e.name||e.FileName||"untitled",[2,new File([t],r,{type:e.type})]}})})},v=function(e){var t=e.keysArr;return r(void 0,void 0,void 0,function(){var e,r,a,u,c,s;return n(this,function(n){switch(n.label){case 0:return[4,i()];case 1:e=n.sent(),r=e.transaction(o,"readwrite"),a=r.objectStore(o),u=0,c=t,n.label=2;case 2:return u<c.length?(s=c[u],[4,a.delete(s)]):[3,5];case 3:n.sent(),n.label=4;case 4:return u++,[3,2];case 5:return[4,r.done];case 6:return n.sent(),[2]}})})},b=function(t){var u=t.entries;return r(void 0,void 0,void 0,function(){var t,r,c,i,l,d,v,b,p,h,y,g,w,m,S;return n(this,function(n){switch(n.label){case 0:return[4,e(a,1)];case 1:t=n.sent(),r=[],c=0,i=u,n.label=2;case 2:return c<i.length?(l=i[c],d=l[0],v=l[1],b=v,Array.isArray(v)&&v.length&&v[0]instanceof File?[4,Promise.all(v.map(f))]:[3,4]):[3,9];case 3:return p=n.sent(),b=s(JSON.stringify(p)),[3,7];case 4:return v instanceof File?[4,f(v)]:[3,6];case 5:return h=n.sent(),b=s(JSON.stringify(h)),[3,7];case 6:(Array.isArray(v)&&v.length||!Array.isArray(v)&&v)&&(b=s(JSON.stringify(v))),n.label=7;case 7:r.push({key:d,value:b}),n.label=8;case 8:return c++,[3,2];case 9:y=t.transaction(o,"readwrite"),g=y.objectStore(o),w=0,m=r,n.label=10;case 10:return w<m.length?(S=m[w],[4,g.put(S)]):[3,13];case 11:n.sent(),n.label=12;case 12:return w++,[3,10];case 13:return[4,y.done];case 14:return n.sent(),[2]}})})},p=function(e){return r(void 0,void 0,void 0,function(){var t,r,a;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,i()];case 1:return[4,n.sent().get(o,e)];case 2:return(t=n.sent())?(r=l(t.value),[2,JSON.parse(r)]):[2,null];case 3:return a=n.sent(),console.error("getDraftFromStorage failed:",a),[2,null];case 4:return[2]}})})},h=function(e){return r(void 0,void 0,void 0,function(){var t,r,a;return n(this,function(n){switch(n.label){case 0:t=0,r=e,n.label=1;case 1:return t<r.length?(a=r[t],[4,y(a)]):[3,4];case 2:if(n.sent())return[2,!0];n.label=3;case 3:return t++,[3,1];case 4:return[2,!1]}})})},y=function(e){return r(void 0,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:return[4,i()];case 1:return[4,r.sent().get(o,e)];case 2:return[2,!(!(t=r.sent())||!t.value)]}})})},g=function(e,t,a){return r(void 0,void 0,void 0,function(){var r,u,c,s,l,f,d;return n(this,function(n){switch(n.label){case 0:return[4,i()];case 1:r=n.sent(),u=r.transaction(o,"readonly").objectStore(o),c=!1,s=0,l=e,n.label=2;case 2:return s<l.length?(f=l[s],[4,u.get(f)]):[3,5];case 3:if((d=n.sent())&&d.value)return c=!0,[3,5];n.label=4;case 4:return s++,[3,2];case 5:return c?setTimeout(function(){t(e,a)},1e3):a(!1),[2]}})})};export{h as checkHasDraftInStorage,g as checkStorageAndNotify,l as decryptPassword,s as encryptPassword,f as fileToJson,p as getDraftFromStorage,d as jsonToFile,v as removeDraftFromStorage,b as saveDraftToStorage};
//# sourceMappingURL=index.js.map
